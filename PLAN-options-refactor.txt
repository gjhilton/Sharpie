================================================================================
ARCHITECTURE REFACTOR PLAN
================================================================================

CRITICAL CONSTRAINT
-------------------
NO VISIBLE CHANGES TO USER except:
- LoadingScreen (new, allowed)
- ErrorBoundary (graceful errors instead of crashes)
- URL reflects options (invisible unless user looks at address bar)

Game end modes are OUT OF SCOPE - future v1.3.0 feature.

================================================================================
PROBLEMS TO FIX (from audit)
================================================================================

| Problem                              | Solution                    |
|--------------------------------------|-----------------------------|
| Prop drilling 5+ levels              | GameOptionsContext          |
| (showBaseline, enabledAlphabets,     |                             |
| onShowFeedback, etc.)                |                             |
|--------------------------------------|-----------------------------|
| State setters passed as props        | Context with actions        |
| (anti-pattern)                       |                             |
|--------------------------------------|-----------------------------|
| No URL persistence                   | TanStack Router + URL state |
| (options lost on refresh)            |                             |
|--------------------------------------|-----------------------------|
| No loading states                    | LoadingScreen + Suspense    |
|--------------------------------------|-----------------------------|
| No error boundaries                  | ErrorBoundary component     |
|--------------------------------------|-----------------------------|
| Inconsistent exports                 | Named exports only          |
| (mixed default/named)                |                             |
|--------------------------------------|-----------------------------|
| Direct DB imports in components      | Inject via context/props    |
|--------------------------------------|-----------------------------|
| Duplicate keydown handlers           | useEnterKey hook            |
|--------------------------------------|-----------------------------|
| Components too large                 | Split into smaller units    |
| (CatalogueScreen, GamePresentation)  |                             |
|--------------------------------------|-----------------------------|
| Inconsistent test mocking            | Standardized test-utils     |

================================================================================
ARCHITECTURE
================================================================================

```
┌─────────────────────────────────────────────────────────────┐
│  TanStack Router                                            │
│  URL = source of truth for game options                     │
│  /, /play, /score, /catalogue, /feedback                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  GameOptionsContext                                         │
│  - options (derived from URL)                               │
│  - updateOption(key, value) → updates URL                   │
│  - resetOptions()                                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  ErrorBoundary + Suspense                                   │
│  - LoadingScreen while loading                              │
│  - ErrorScreen on failure                                   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  Screen Components                                          │
│  - useGameOptions() hook - no prop drilling                 │
│  - Same appearance as before                                │
└─────────────────────────────────────────────────────────────┘
```

================================================================================
FILE STRUCTURE
================================================================================

src/
├── lib/
│   ├── options/
│   │   ├── schema.js           # All options defined here
│   │   ├── defaults.js         # Default values (match current behavior)
│   │   ├── serializer.js       # URL ↔ options conversion
│   │   ├── alphabets.js        # Alphabet ID utilities
│   │   ├── index.js            # Public exports
│   │   └── *.test.js           # Tests for each
│   │
│   └── hooks/
│       ├── useEnterKey.js      # Shared keydown handler
│       ├── useGameOptions.js   # Access options context
│       └── index.js
│
├── context/
│   └── GameOptionsContext.jsx  # Options + update actions
│
├── routes/
│   ├── __root.jsx              # Layout + providers
│   ├── index.jsx               # / → LandingScreen
│   ├── play.jsx                # /play → GameScreen
│   ├── score.jsx               # /score → ScoreScreen
│   ├── catalogue.jsx           # /catalogue → CatalogueScreen
│   └── feedback.jsx            # /feedback → FeedbackScreen
│
├── components/
│   ├── screens/                # Full-page views
│   │   ├── LandingScreen/
│   │   ├── GameScreen/
│   │   ├── ScoreScreen/
│   │   ├── CatalogueScreen/
│   │   ├── FeedbackScreen/
│   │   ├── LoadingScreen/      # NEW - only visible addition
│   │   └── ErrorScreen/        # NEW - replaces crashes
│   │
│   ├── common/
│   │   └── ErrorBoundary.jsx
│   │
│   └── ui/                     # Pure presentational (existing)
│
├── router.js                   # TanStack Router config
│
├── test-utils/                 # Standardized test helpers
│   └── index.js
│
└── data/
    └── alphabets.json          # Add "id" field to each alphabet

================================================================================
OPTIONS SCHEMA
================================================================================

Current options only (no new options in this refactor):

```js
export const OPTIONS = {
  mode: {
    key: 'mode',
    type: 'enum',
    urlParam: 'm',
    default: 'all',
    values: {
      all: { label: 'both minuscules AND MAJUSCULES', urlValue: 'a' },
      minuscule: { label: 'minuscules only', urlValue: 'i' },
      majuscule: { label: 'MAJUSCULES only', urlValue: 'j' },
    },
  },

  alphabets: {
    key: 'enabledAlphabets',
    type: 'alphabetSet',
    urlParam: 'a',
    default: null,  // uses alphabets.json isDefaultEnabled
  },

  twentyFourLetter: {
    key: 'twentyFourLetterAlphabet',
    type: 'boolean',
    urlParam: 'l',
    default: false,
  },

  showBaseline: {
    key: 'showBaseline',
    type: 'boolean',
    urlParam: 'b',
    default: true,
  },
};
```

================================================================================
CONTEXT DESIGN
================================================================================

```jsx
// context/GameOptionsContext.jsx
import { createContext, useContext } from 'react';
import { useSearch, useNavigate } from '@tanstack/react-router';
import { deserializeOptions, serializeOption } from '@lib/options';

const GameOptionsContext = createContext(null);

export const GameOptionsProvider = ({ children }) => {
  const search = useSearch({ strict: false });
  const navigate = useNavigate();

  const options = deserializeOptions(search);

  const updateOption = (key, value) => {
    navigate({
      search: prev => ({ ...prev, ...serializeOption(key, value) }),
      replace: true,
    });
  };

  const resetOptions = () => {
    navigate({ search: {}, replace: true });
  };

  return (
    <GameOptionsContext.Provider value={{ options, updateOption, resetOptions }}>
      {children}
    </GameOptionsContext.Provider>
  );
};

export const useGameOptions = () => {
  const context = useContext(GameOptionsContext);
  if (!context) {
    throw new Error('useGameOptions must be used within GameOptionsProvider');
  }
  return context;
};
```

================================================================================
URL SCHEMA
================================================================================

Example: /?m=a&l=0&b=1&a=001,003,004

| Option           | Param | Values                    | Default |
|------------------|-------|---------------------------|---------|
| mode             | m     | a/i/j (all/minusc/majusc) | a       |
| twentyFourLetter | l     | 0/1                       | 0       |
| showBaseline     | b     | 0/1                       | 1       |
| enabledAlphabets | a     | comma-separated IDs       | (all defaults) |

================================================================================
ROUTES
================================================================================

| Path        | Component        | Description              |
|-------------|------------------|--------------------------|
| /           | LandingScreen    | Home with options        |
| /play       | GameScreen       | Game in progress         |
| /score      | ScoreScreen      | Results after game       |
| /catalogue  | CatalogueScreen  | Browse/select alphabets  |
| /feedback   | FeedbackScreen   | Feedback form            |

================================================================================
RELEASE PLAN
================================================================================

v1.2.0 — Component Cleanup (COMPLETE)
--------------------------------------------------------------
RULE: Sub-components used by one parent stay in that parent's folder.

Shared utilities:
[x] Create src/lib/hooks/useEnterKey.js (extract from 3 locations)
[x] Create src/lib/utils/classNames.js (className concatenation utility)
[x] Create src/lib/styles/focus.js (shared focus ring styles)
[x] Create src/lib/styles/disabled.js (shared disabled styles)
[x] Create src/constants/spacing.js (extract from GamePresentation, CatalogueScreen)

Bug fixes:
[x] FIX: CharacterImage.jsx - padding typo '0m' → '0'
[x] FIX: BulkSelectionLink.jsx - change <a href="#"> to <button>

Extract sub-components to parent folders:
[x] CatalogueScreen/ folder
[x] GamePresentation/ folder
[x] ScoreScreen/ folder
[x] FeedbackScreen/ folder
[x] Button/ folder
[x] Character/ folder

Styling standardization:
[x] Replace style={{}} with css({}) in components

Use shared utilities:
[x] Replace className concatenations with classNames()
[x] Replace keyboard listeners with useEnterKey()

Export standardization:
[x] Standardize all exports to named only (no default exports)

Final:
[x] Update affected tests
[x] Run full test suite
[x] Manual test: verify identical behavior

--------------------------------------------------------------------------------

v1.2.1 — Foundation (COMPLETE)
----------------------------------------
[x] Add unique IDs (001, 002, etc.) to alphabets.json
[x] Create src/lib/options/schema.js
[x] Create src/lib/options/defaults.js
[x] Create src/lib/options/serializer.js
[x] Create src/lib/options/alphabets.js
[x] Create src/lib/options/index.js
[x] Write tests for all options library files
[x] Create src/test-utils/index.js
[x] Run existing tests (no changes to app yet)

v1.2.2 — Infrastructure (COMPLETE)
-----------------------------------------------------------
[x] Install TanStack Router
[x] Create src/router.js
[x] Create route files (not active yet)
[x] Create src/context/GameOptionsContext.jsx
[x] Create src/lib/hooks/useGameOptions.js
[x] Create LoadingScreen component
[x] Create ErrorScreen component
[x] Create ErrorBoundary component
[x] Write tests for all new components
[x] Run existing tests (app still works as before)

v1.2.3 — Migration (IN PROGRESS)
-----------------------------------------------

Architecture migration:
[x] Activate router in App.jsx (RouterProvider)
[x] Migrate LandingScreen to use useGameOptions()
[x] Migrate GameScreen to use useGameOptions()
[x] Migrate ScoreScreen to use useGameOptions()
[x] Migrate CatalogueScreen to use useGameOptions()
[x] Migrate FeedbackScreen to use useGameOptions()
[x] Wrap app in ErrorBoundary + Suspense
[x] Remove stage-based switching from App.jsx
[ ] Remove GAME_MODES, GAME_MODE_OPTIONS from stages.js

Context migration (eliminate prop drilling):
[x] Remove setState props - setShowBaseline, setEnabledAlphabets (use context actions)
[ ] Remove direct DB imports from presentation components (inject via context)

Final verification:
[ ] Update all component tests for router context
[ ] Run full test suite
[ ] Manual test: verify identical behavior

================================================================================
CONVENTIONS TO ENFORCE
================================================================================

1. EXPORTS: Named exports only (no default exports)
   export { Component };  // YES
   export default Component;  // NO

2. CONTEXT: Never pass state setters as props
   <Child onChange={handleChange} />  // YES
   <Child setState={setState} />  // NO

3. STYLING: css({}) only, no inline style={{}}
   className={css({ color: 'red' })}  // YES
   style={{ color: 'red' }}  // NO

4. HOOKS: Custom hooks in src/lib/hooks/

5. TESTING: Use shared test-utils with pre-configured providers

6. COMPONENTS: Max ~200 lines, split if larger

================================================================================
OUT OF SCOPE (Future v1.3.0)
================================================================================

- Game end modes (ON_QUIT, FIXED_NUM, SUDDEN_DEATH, THREE_LIVES)
- GameProgress component
- OptionsSummary with copy link
- Any new options or features
- Any UI changes (except LoadingScreen)

================================================================================
